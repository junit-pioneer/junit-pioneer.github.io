<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Clear, Set, and Restore Environment Variables - JUnit Pioneer</title>
<meta name="description" content="The JUnit 5 (Jupiter) extensions @ClearEnvironmentVariable, @SetEnvironmentVariable and @RestoreEnvironmentVariables clear/set/restore the values of environment variables for the duration of a test, and/or restore them after">


  <meta name="author" content="JUnit Pioneers">


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="JUnit Pioneer">
<meta property="og:title" content="Clear, Set, and Restore Environment Variables">
<meta property="og:url" content="https://junit-pioneer.org/docs/environment-variables/">


  <meta property="og:description" content="The JUnit 5 (Jupiter) extensions @ClearEnvironmentVariable, @SetEnvironmentVariable and @RestoreEnvironmentVariables clear/set/restore the values of environment variables for the duration of a test, and/or restore them after">



  <meta property="og:image" content="https://junit-pioneer.org/assets/images/site/type-writer.jpg">





  <meta property="article:published_time" content="2023-09-11T21:01:55+00:00">





  

  


<link rel="canonical" href="https://junit-pioneer.org/docs/environment-variables/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "JUnit Pioneers",
      "url": "https://junit-pioneer.org/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="JUnit Pioneer Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single-doc">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          JUnit Pioneer
          <span class="site-subtitle">JUnit 5 Extension Pack</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/docs/">Documentation</a>
            </li><li class="masthead__menu-item">
              <a href="https://javadoc.io/doc/org.junit-pioneer/junit-pioneer">Javadoc</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/junit-pioneer/junit-pioneer/releases">Release Notes</a>
            </li><li class="masthead__menu-item">
              <a href="/junit-pioneer/">About</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/junit-pioneer/junit-pioneer">GitHub</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      <!-- BEGIN: edited version of page__hero.html -->








<div class="page__hero--overlay"
  style=" background-image: url('/assets/images/site/type-writer.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline"
        style="">
        
          Clear, Set, and Restore Environment Variables

        
      </h1>
      


      
      
    </div>
  
  
</div>
<!-- END -->



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">JUnit Pioneer Extensions</span>
        

        
        <ul>
          
            <li><a href="/docs/cartesian-product/">Cartesian Product of Parameters</a></li>
          
            <li><a href="/docs/system-properties/">Clear, Set, and Restore System Properties</a></li>
          
            <li class="active"><a href="/docs/environment-variables/">Clear, Set, and Restore Environment Variables</a></li>
          
            <li><a href="/docs/byte-array-converter/">Convert Number Argument to Byte Array</a></li>
          
            <li><a href="/docs/default-locale-timezone/">Default Locale and TimeZone</a></li>
          
            <li><a href="/docs/disabled-until/">Disable a Test Temporarily</a></li>
          
            <li><a href="/docs/disable-if-test-fails/">Disable If Test Fails</a></li>
          
            <li><a href="/docs/disable-parameterized-tests/">Disable Parameterized Tests</a></li>
          
            <li><a href="/docs/expected-to-fail-tests/">Expected-to-Fail Tests</a></li>
          
            <li><a href="/docs/resources/">Injecting Resources</a></li>
          
            <li><a href="/docs/temp-directory/">Injecting Temporary Directories</a></li>
          
            <li><a href="/docs/issue/">Issue Information</a></li>
          
            <li><a href="/docs/json-argument-source">JSON Argument Source</a></li>
          
            <li><a href="/docs/stopwatch/">Measuring Test Run Time</a></li>
          
            <li><a href="/docs/report-entries/">Publishing Report Entries</a></li>
          
            <li><a href="/docs/range-sources/">Range Sources</a></li>
          
            <li><a href="/docs/retrying-test/">Retrying Failing Tests</a></li>
          
            <li><a href="/docs/standard-input-output/">Standard Input and Output</a></li>
          
            <li><a href="/docs/simple-arguments-aggregator/">Simple Arguments Aggregator</a></li>
          
            <li><a href="/docs/vintage-test/">Vintage @Test</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Clear, Set, and Restore Environment Variables">
    <meta itemprop="description" content="@ClearEnvironmentVariable and @SetEnvironmentVariableThe @ClearEnvironmentVariable and @SetEnvironmentVariable annotations can be used to clear and set, respectively, the values of environment variables for a test execution.Both annotations work on the test method and class level, are repeatable, combinable, and inherited from higher-level containers.After the annotated method has been executed, the variables mentioned in the annotation will be restored to their original value or the value of the higher-level container, or will be cleared if they didn&#8217;t have one before.Other environment variables that are changed during the test, are not restored (unless the @RestoreEnvironmentVariables is used).">
    
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <div class="sect1">
<h2 id="clearenvironmentvariable-and-setenvironmentvariable"><code>@ClearEnvironmentVariable</code> and <code>@SetEnvironmentVariable</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>@ClearEnvironmentVariable</code> and <code>@SetEnvironmentVariable</code> annotations can be used to clear and set, respectively, the values of environment variables for a test execution.
Both annotations work on the test method and class level, are repeatable, combinable, and inherited from higher-level containers.
After the annotated method has been executed, the variables mentioned in the annotation will be restored to their original value or the value of the higher-level container, or will be cleared if they didn&#8217;t have one before.
Other environment variables that are changed during the test, are <strong>not</strong> restored (unless the <code>@RestoreEnvironmentVariables</code> is used).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Java considers environment variables to be immutable, so this extension uses reflection to change them.
This requires that the <code>SecurityManager</code> allows modifications and can potentially break on different operating systems and Java versions.
Be aware that this is a fragile solution and consider finding a better one for your specific situation.
For more details, see <a href="#warnings-for-reflective-access">Warnings for Reflective Access</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example, clearing a environment variable for a test execution can be done as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@Test</span>
<span style="color: #a6e22e">@ClearEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">testClear</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And setting a environment variable for a test execution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@Test</span>
<span style="color: #a6e22e">@SetEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">testSet</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isEqualTo</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned before, both annotations are repeatable and they can also be combined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@Test</span>
<span style="color: #a6e22e">@ClearEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;1st variable&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #a6e22e">@ClearEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;2nd variable&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #a6e22e">@SetEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;3rd variable&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">testClearAndSet</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;1st variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;2nd variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;3rd variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isEqualTo</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that class-level configurations are overwritten by method-level configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@ClearEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">MyEnvironmentVariableTest</span> <span style="color: #f8f8f2">{</span>

    <span style="color: #a6e22e">@Test</span>
    <span style="color: #a6e22e">@SetEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">)</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">clearedAtClasslevel</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;some variable&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isEqualTo</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;new value&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Method-level configurations are visible in both <code>@BeforeEach</code> setup methods and <code>@AfterEach</code> teardown methods (see <a href="https://junit.org/junit5/docs/current/user-guide/#extensions-execution-order-overview">user code and extension code execution order</a>).</p>
</div>
<div class="paragraph">
<p>Since v1.7.0, a class-level configuration means that the specified environment variables are cleared/set before and reset after each individual test in the annotated class.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restoreenvironmentvariables"><code>@RestoreEnvironmentVariables</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@RestoreEnvironmentVariables</code> can be used to restore changes to environment variables made directly in code.
While <code>@ClearEnvironmentVariable</code> and <code>@SetEnvironmentVariable</code> set or clear specific variables and values, they don&#8217;t allow values to be calculated or parameterized, thus there are times you may want to directly set them in your test code.
<code>@RestoreEnvironmentVariables</code> can be placed on test methods or test classes and will completely restore all environment variables to their original state after a test or test class is complete.</p>
</div>
<div class="paragraph">
<p>In this example, <code>@RestoreEnvironmentVariables</code> is used on a test method, ensuring any changes made in that method are restored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@ParameterizedTest</span>
<span style="color: #a6e22e">@ValueSource</span><span style="color: #f8f8f2">(strings</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">{</span> <span style="color: #e6db74">&quot;foo&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;bar&quot;</span> <span style="color: #f8f8f2">})</span>
<span style="color: #a6e22e">@RestoreEnvironmentVariables</span>
<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">parameterizedTest</span><span style="color: #f8f8f2">(String</span> <span style="color: #f8f8f2">value)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;some parameterized property&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">value);</span>
    <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;some other dynamic property&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;my code calculates somehow&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Modifying environment variables of a running JVM requires several lines of code and the Java reflection API.
The two <code>@RestoreEnvironmentVariables</code> examples leave out that detail and use a hypothetical <code>setEnvVar()</code> method.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When <code>@RestoreEnvironmentVariables</code> is used on a test class, any environment variable changes made during the entire lifecycle of the test class, including test methods, <code>@BeforeAll</code>, <code>@BeforeEach</code> and 'after' methods, are restored after the test class' lifecycle is complete.
In addition, the annotation is inherited by each test method just as if each one was annotated with <code>@RestoreEnvironmentVariables</code>.</p>
</div>
<div class="paragraph">
<p>In the following example, both test methods see the environment variable changes made in <code>@BeforeAll</code> and <code>@BeforeEach</code>, however, the test methods are isolated from each other (<code>isolatedTest2</code> does not 'see' changes made in <code>isolatedTest1</code>).
As shown in the second example below, the class-level <code>@RestoreEnvironmentVariables</code> ensures that environment variable changes made within the annotated class are completely restored after the class&#8217;s lifecycle, ensuring that changes are not visible to <code>SomeOtherTestClass</code>.
Note that <code>SomeOtherTestClass</code> uses the <code>@ReadsEnvironmentVariable</code> annotation: This ensures that JUnit does not schedule the class to run during any test known to modify environment variables (see <a href="#thread-safety">Thread-Safety</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@RestoreEnvironmentVariables</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">EnvironmentVarRestoreTest</span> <span style="color: #f8f8f2">{</span>

    <span style="color: #a6e22e">@BeforeAll</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">beforeAll</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;A&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;A value&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">@BeforeEach</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">beforeEach</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;B&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;B value&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">@Test</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">isolatedTest1</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;C value&quot;</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">@Test</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">isolatedTest2</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;A&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isEqualTo</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;A value&quot;</span><span style="color: #f8f8f2">);</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;B&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isEqualTo</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;B value&quot;</span><span style="color: #f8f8f2">);</span>

        <span style="color: #75715e">// Class-level @RestoreEnvironmentVariables restores &quot;C&quot; to original state</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some other test class, running later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #75715e">// A test class that runs later</span>
<span style="color: #a6e22e">@ReadsEnvironmentVariable</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">SomeOtherTestClass</span> <span style="color: #f8f8f2">{</span>

    <span style="color: #a6e22e">@Test</span>
    <span style="color: #66d9ef">void</span> <span style="color: #a6e22e">isolatedTest</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Class-level @RestoreEnvironmentVariables restores all changes made in EnvironmentVarRestoreTest</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;A&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;B&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
        <span style="color: #f8f8f2">assertThat(System.</span><span style="color: #a6e22e">getenv</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;C&quot;</span><span style="color: #f8f8f2">)).</span><span style="color: #a6e22e">isNull</span><span style="color: #f8f8f2">();</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #75715e">// Changes to A, B, C have been restored to their values prior to the above test</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-clearenvironmentvariable-setenvironmentvariable-and-restoreenvironmentvariables-together">Using <code>@ClearEnvironmentVariable</code>, <code>@SetEnvironmentVariable</code>, and <code>@RestoreEnvironmentVariables</code> together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All three annotations can be combined, which could be used when some environment values are parameterized (i.e. need to be set in code) and others are not.
For instance, imagine testing an image generation utility that takes configuration from environment variables.
Basic configuration can be specified using <code>Set</code> and <code>Clear</code> and the image size parameterized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code data-lang="java"><span></span><span style="color: #a6e22e">@ParameterizedTest</span>
<span style="color: #a6e22e">@IntRangeSource</span><span style="color: #f8f8f2">(from</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">to</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">10000</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">step</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">500</span><span style="color: #f8f8f2">)</span>
<span style="color: #a6e22e">@RestoreEnvironmentVariables</span>
<span style="color: #a6e22e">@SetEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;DISABLE_CACHE&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">value</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;TRUE&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #a6e22e">@ClearEnvironmentVariable</span><span style="color: #f8f8f2">(key</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;COPYWRITE_OVERLAY_TEXT&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">imageGenerationTest</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">imageSize)</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">setEnvVar(</span><span style="color: #e6db74">&quot;IMAGE_SIZE&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">String.</span><span style="color: #a6e22e">valueOf</span><span style="color: #f8f8f2">(imageSize));</span> <span style="color: #75715e">// Requires restore</span>

    <span style="color: #75715e">// Test your image generation utility with the current environment variables</span>
<span style="color: #f8f8f2">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Using <code>@RestoreEnvironmentVariables</code> is not necessary to restore environment variables modified via <code>@ClearEnvironmentVariable</code> or <code>@SetEnvironmentVariable</code> - they each automatically restore the referenced variables.
'Restore', is only needed if environment variables are modified in some way <em>other than</em> Clear and Set during a test.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="warnings-for-reflective-access">Warnings for Reflective Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As explained above, this extension uses reflective access to change the otherwise immutable environment variables.
On Java 9 to 16, this leads to a warning like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code><span></span>[ERROR] WARNING: An illegal reflective access operation has occurred
[ERROR] WARNING: Illegal reflective access by org.junitpioneer.jupiter.EnvironmentVariableUtils [...] to field [...]
[ERROR] WARNING: Please consider reporting this to the maintainers of org.junitpioneer.jupiter.EnvironmentVariableUtils
[ERROR] WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
[ERROR] WARNING: All illegal access operations will be denied in a future release</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Java 17 and later, you get this error instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code><span></span>java.lang.reflect.InaccessibleObjectException: Unable to make field [...] accessible:
module java.base does not &quot;opens java.lang&quot; to unnamed module [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The best way to prevent these warnings/errors, is to change the code under test, so this extension is no longer needed.
The next best thing is to allow access to that specific package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #272822; color: #f8f8f2"><code><span></span>--add-opens java.base/java.util=$TARGET_MODULE
--add-opens java.base/java.lang=$TARGET_MODULE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>$TARGET_MODULE</code> equals <code>ALL-UNNAMED</code> if you place JUnit Pioneer on the class path, or <code>org.junitpioneer</code> if you place JUnit Pioneer on the module path.
These command line options need to be added to the JVM that executes the tests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.gradle.org/current/dsl/org.gradle.api.tasks.testing.Test.html">Gradle</a></p>
</li>
<li>
<p><a href="https://maven.apache.org/surefire/maven-surefire-plugin/test-mojo.html#argLine">Maven basics</a> and <a href="https://nipafx.dev/maven-on-java-9/">advanced</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="thread-safety">Thread-Safety</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since environment variables are global state, reading and writing them during <a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-parallel-execution">parallel test execution</a> can lead to unpredictable results and flaky tests.
The environment variable extension is prepared for that and tests annotated with <code>@ClearEnvironmentVariable</code>, <code>@SetEnvironmentVariable</code>, or <code>@RestoreEnvironmentVariables</code> will never execute in parallel (thanks to <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/parallel/ResourceLock.html">resource locks</a>) to guarantee correct test results.</p>
</div>
<div class="paragraph">
<p>However, this does not cover all possible cases.
Tested code that reads or writes environment variables <em>independently</em> of the extension can still run in parallel to it and may thus behave erratically when, for example, it unexpectedly reads a variable set by the extension in another thread.
Tests that cover code that reads or writes environment variables need to be annotated with the respective annotation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@ReadsEnvironmentVariable</code></p>
</li>
<li>
<p><code>@WritesEnvironmentVariable</code> (though consider using <code>@RestoreEnvironmentVariables</code> instead)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Tests annotated in this way will never execute in parallel with tests annotated with <code>@ClearEnvironmentVariable</code>, <code>@SetEnvironmentVariable</code>, or <code>@RestoreEnvironmentVariables</code>.</p>
</div>
</div>
</div>
        
      </section>

      <footer class="page__meta">
        
        


        

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Clear%2C+Set%2C+and+Restore+Environment+Variables%20https%3A%2F%2Fjunit-pioneer.org%2Fdocs%2Fenvironment-variables%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fjunit-pioneer.org%2Fdocs%2Fenvironment-variables%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fjunit-pioneer.org%2Fdocs%2Fenvironment-variables%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/hashtag/JUnitPioneer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/junit-pioneer" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 JUnit Pioneers, <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC 4.0</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
